
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- CONFIGURA√á√ÉO PWA -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>JDP EDITOR v2.1 | HYPER-DRIVE</title>
 
    <!-- MOTOR GR√ÅFICO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --gold: #f59e0b; --dark: #000000; --glass: rgba(20, 20, 20, 0.95); --neon: #00f3ff; --red: #ef4444; --blue: #3b82f6; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--dark); 
            color: white; 
            margin: 0; padding: 0; 
            overflow: hidden; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            height: 100vh; width: 100vw; 
            display: flex; flex-direction: column; 
        }

        /* --- PALCO DE CRIA√á√ÉO --- */
        #palco-criacao { 
            flex: 1; position: relative; overflow: hidden; 
            background: radial-gradient(circle, #222 0%, #000 100%); 
            touch-action: none; width: 100%; height: 100%; 
        }

        #layer-fundo { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 0; pointer-events: none; 
        }
        #layer-fundo video, #layer-fundo img { width: 100%; height: 100%; object-fit: cover; }

        /* --- ELEMENTOS --- */
        .elemento-studio { 
            position: absolute; cursor: grab; user-select: none; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 10; transition: box-shadow 0.2s; 
        }
        .elemento-studio.selecionado { 
            border: 2px dashed var(--gold); 
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); 
            z-index: 100 !important; 
        }
        .btn-fechar-item { 
            position: absolute; top: -15px; right: -15px; 
            width: 30px; height: 30px; background: var(--red); color: white; 
            border-radius: 50%; border: 2px solid white; 
            display: none; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 14px; cursor: pointer; z-index: 200; 
        }
        .elemento-studio.selecionado .btn-fechar-item { display: flex; }
        .elemento-studio img, .elemento-studio video { 
            width: 100%; height: 100%; pointer-events: none; display: block; 
            object-fit: cover; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
        }
        .elemento-studio div[contenteditable] { 
            padding: 10px; color: white; font-weight: bold; 
            text-shadow: 3px 3px 0px #000; font-size: 32px; 
            text-transform: uppercase; font-family: 'Impact', sans-serif; 
            letter-spacing: 2px; text-align: center; min-width: 100px; 
        }

        /* EFEITOS */
        .efeito-vida { animation: respirar 3s infinite ease-in-out; }
        @keyframes respirar { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- INTERFACE --- */
        .dock-ferramentas { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 15px; background: var(--glass); 
            padding: 15px 30px; border-radius: 50px; backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.15); z-index: 200; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); 
        }
        .btn-float { 
            width: 50px; height: 50px; border-radius: 50%; border: none; 
            background: #333; color: white; font-size: 22px; flex-shrink: 0; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: 0.2s; cursor: pointer; 
        }
        .btn-float:active { transform: scale(0.9); background: var(--gold); color: black; }

        .top-bar { 
            position: absolute; top: 20px; left: 20px; right: 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 300; pointer-events: none; 
        }
        .top-bar * { pointer-events: auto; }
        .logo-jdp { font-size: 12px; color: #666; letter-spacing: 2px; font-weight: bold; }
        
        /* BOT√ÉO SALVAR ELEVADO */
        .btn-exportar { 
            background: linear-gradient(135deg, var(--gold), #d97706); 
            color: black; padding: 10px 25px; border-radius: 30px; 
            font-weight: bold; border: none; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); 
            cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; 
            transition: transform 0.2s;
        }
        .btn-exportar:active { transform: scale(0.95); }

        /* MENUS */
        #menu-fundo { 
            position: absolute; bottom: 110px; left: 50%; transform: translateX(-50%); 
            background: #222; padding: 15px; border-radius: 20px; 
            border: 1px solid var(--gold); display: none; gap: 10px; z-index: 201; 
        }
        #controle-zoom { 
            position: absolute; bottom: 110px; left: 50%; transform: translateX(-50%); 
            width: 60%; background: rgba(0,0,0,0.8); padding: 15px; 
            border-radius: 20px; display: none; z-index: 200; 
            text-align: center; border: 1px solid var(--gold); 
        }
        #controle-zoom input { width: 100%; accent-color: var(--gold); }

        /* MODAL EXPORTA√á√ÉO */
        #modal-export { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 500; 
            align-items: center; justify-content: center; flex-direction: column; 
        }
        .card-export { 
            background: #111; border: 1px solid var(--gold); padding: 30px; 
            border-radius: 20px; width: 85%; max-width: 320px; text-align: center; 
            box-shadow: 0 0 50px rgba(245, 158, 11, 0.2);
        }
        .btn-opt { 
            width: 100%; padding: 16px; margin: 8px 0; border-radius: 12px; border: none; 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; 
            font-size: 14px; transition: all 0.2s;
        }
        .btn-opt:active { transform: scale(0.98); opacity: 0.8; }
        
        /* STATUS */
        #status-gravacao { 
            position: absolute; top: 70px; right: 20px; 
            background: rgba(220, 38, 38, 0.9); color: white; 
            padding: 8px 20px; border-radius: 30px; font-weight: bold; font-size: 12px; 
            display: none; align-items: center; gap: 8px; z-index: 4000; 
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
            animation: piscarRec 1s infinite; 
        }
        @keyframes piscarRec { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #audio-player { display: none; }
        
        /* LOADER */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--gold); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="logo-jdp">JDP EDITOR v2.1</div>
        <button class="btn-exportar" onclick="abrirModalExport()">
            <i class="fas fa-save"></i> FINALIZAR
        </button>
    </div>

    <div id="status-gravacao"><i class="fas fa-circle"></i> GRAVANDO <span id="timer-rec">00</span>s</div>

    <div id="palco-criacao" onclick="deselecionarTudo(event)">
        <!-- O atributo data-tipo ser√° crucial aqui -->
        <div id="layer-fundo" data-tipo="cor"></div>
    </div>

    <audio id="audio-player" loop></audio>

    <div id="controle-zoom">
        <label style="color:var(--gold); font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">ZOOM</label>
        <input type="range" min="20" max="400" value="100" oninput="ajustarZoom(this.value)">
    </div>

    <div id="menu-fundo">
        <button class="btn-float" onclick="setFundoCor('#000')" style="background:black; border:1px solid #333;"></button>
        <button class="btn-float" onclick="setFundoCor('#f59e0b')" style="background:var(--gold);"></button>
        <label class="btn-float" style="background:#444;">
            <i class="fas fa-image"></i> 
            <input type="file" accept="image/*" style="display:none" onchange="setFundoMidia(this, 'img')">
        </label>
        <label class="btn-float" style="background:#444; border:1px solid red;">
            <i class="fas fa-video"></i> 
            <input type="file" accept="video/*" style="display:none" onchange="setFundoMidia(this, 'video')">
        </label>
    </div>

    <div class="dock-ferramentas">
        <button class="btn-float" onclick="toggleMenuFundo()" title="Fundo"><i class="fas fa-fill-drip"></i></button>
        <label class="btn-float" title="Add Foto"><i class="fas fa-camera"></i> <input type="file" accept="image/*" style="display:none" onchange="addItem(this, 'img')"></label>
        <label class="btn-float" title="Add V√≠deo"><i class="fas fa-film"></i> <input type="file" accept="video/*" style="display:none" onchange="addItem(this, 'video')"></label>
        <label class="btn-float" title="Add M√∫sica" style="border:1px solid var(--neon);"><i class="fas fa-music"></i> <input type="file" accept="audio/*" style="display:none" onchange="addMusica(this)"></label>
        <button class="btn-float" onclick="addTexto()" title="Texto"><i class="fas fa-font"></i></button>
        <button class="btn-float" onclick="toggleVida()" title="Animar"><i class="fas fa-bolt"></i></button>
    </div>

    <div id="modal-export">
        <div class="card-export">
            <h3 style="color:var(--gold); margin-top:0; text-transform:uppercase; letter-spacing:1px;">Exportar Projeto</h3>
            <p id="aviso-tipo-fundo" style="font-size:12px; color:#999; margin-bottom:20px; line-height:1.4;"></p>
            
            <button id="btn-dl-img" class="btn-opt" style="background:var(--blue); color:white;" onclick="baixarFoto()">
                <i class="fas fa-camera-retro"></i> SALVAR COMO IMAGEM
            </button>
            
            <div style="width:100%; height:1px; background:#333; margin:15px 0;"></div>
            
            <button id="btn-dl-vid-15" class="btn-opt" style="background:var(--red); color:white;" onclick="iniciarGravacao(15)">
                <i class="fas fa-video"></i> GRAVAR STORY (15s)
            </button>
            
            <button id="btn-dl-vid-30" class="btn-opt" style="background:var(--red); color:white;" onclick="iniciarGravacao(30)">
                <i class="fas fa-video"></i> GRAVAR STATUS (30s)
            </button>

            <button class="btn-opt" style="background:#222; color:#888; margin-top:15px; border:1px solid #333;" onclick="document.getElementById('modal-export').style.display='none'">
                CANCELAR
            </button>
        </div>
    </div>

    <script>
        /* --- JDP ENGINE v2.1 - HYPER-DRIVE CORE --- */
        
        let elementoSelecionado = null;
        let offset = { x: 0, y: 0 };
        let modoGravacaoAtivo = false;
        let mediaRecorder;
        let recordedChunks = [];

        /* --- INTELIG√äNCIA DE FUNDO --- */
        function toggleMenuFundo() {
            const menu = document.getElementById('menu-fundo');
            document.getElementById('controle-zoom').style.display = 'none';
            menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        }

        function setFundoCor(cor) {
            const layer = document.getElementById('layer-fundo');
            layer.innerHTML = ''; 
            layer.style.background = cor; 
            layer.setAttribute('data-tipo', 'cor');
            toggleMenuFundo();
        }

        function setFundoMidia(input, tipo) {
            const file = input.files[0]; if (!file) return;
            const url = URL.createObjectURL(file);
            const layer = document.getElementById('layer-fundo');
            layer.style.background = 'transparent';
            
            if(tipo === 'video') {
                layer.innerHTML = `<video id="video-bg" src="${url}" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>`;
                layer.setAttribute('data-tipo', 'video');
            } else {
                layer.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;">`;
                layer.setAttribute('data-tipo', 'imagem');
            }
            toggleMenuFundo();
        }

        /* --- GEST√ÉO DE ITENS --- */
        function criarContainer(conteudoHTML, tipo) {
            const div = document.createElement('div'); div.className = 'elemento-studio'; 
            div.style.top = '30%'; div.style.left = '30%';
            if(tipo === 'midia') { div.style.width = '200px'; div.style.height = 'auto'; }
            
            const btnX = document.createElement('div'); btnX.className = 'btn-fechar-item'; btnX.innerHTML = '<i class="fas fa-times"></i>';
            btnX.onclick = (e) => { e.stopPropagation(); div.remove(); document.getElementById('controle-zoom').style.display='none'; };
            
            div.innerHTML = conteudoHTML; div.appendChild(btnX);
            configurarInteracao(div); document.getElementById('palco-criacao').appendChild(div); selecionarElemento(div);
        }

        function addItem(input, tipo) {
            const file = input.files[0]; if (!file) return;
            const url = URL.createObjectURL(file);
            criarContainer(tipo === 'video' ? `<video src="${url}" autoplay loop muted playsinline></video>` : `<img src="${url}">`, 'midia');
        }

        function addTexto() {
            const texto = prompt("Digite o texto:", "OFERTA"); if(!texto) return;
            criarContainer(`<div contenteditable="true" style="color:var(--gold);">${texto}</div>`, 'texto');
        }

        function addMusica(input) {
            const file = input.files[0]; if(!file) return;
            const audio = document.getElementById('audio-player');
            audio.src = URL.createObjectURL(file);
            audio.play();
            alert("üéµ M√∫sica carregada!");
        }

        /* --- INTERA√á√ÉO --- */
        function configurarInteracao(el) {
            el.addEventListener('touchstart', (e) => {
                if(e.target.closest('.btn-fechar-item') || modoGravacaoAtivo) return;
                selecionarElemento(el);
                const touch = e.touches[0]; offset.x = touch.clientX - el.offsetLeft; offset.y = touch.clientY - el.offsetTop;
            });
            el.addEventListener('touchmove', (e) => { 
                if(modoGravacaoAtivo) return;
                e.preventDefault(); const touch = e.touches[0];
                el.style.left = (touch.clientX - offset.x) + 'px'; el.style.top = (touch.clientY - offset.y) + 'px';
            });
            el.addEventListener('mousedown', (e) => {
                if(e.target.closest('.btn-fechar-item') || modoGravacaoAtivo) return;
                selecionarElemento(el); offset.x = e.clientX - el.offsetLeft; offset.y = e.clientY - el.offsetTop;
                document.onmousemove = (ev) => { ev.preventDefault(); el.style.left = (ev.clientX - offset.x) + 'px'; el.style.top = (ev.clientY - offset.y) + 'px'; };
                document.onmouseup = () => { document.onmousemove = null; document.onmouseup = null; };
            });
        }

        function selecionarElemento(el) {
            if(modoGravacaoAtivo) return;
            document.querySelectorAll('.elemento-studio').forEach(e => e.classList.remove('selecionado'));
            elementoSelecionado = el; el.classList.add('selecionado');
            document.getElementById('menu-fundo').style.display = 'none';
            document.getElementById('controle-zoom').style.display = 'block';
            const scale = el.style.transform.replace(/[^0-9.]/g, '') || 1; 
            document.querySelector('#controle-zoom input').value = scale * 100;
        }

        function deselecionarTudo(e) {
            if(modoGravacaoAtivo) return;
            if(e.target.id === 'palco-criacao' || e.target.id === 'layer-fundo') {
                document.querySelectorAll('.elemento-studio').forEach(e => e.classList.remove('selecionado'));
                elementoSelecionado = null; document.getElementById('controle-zoom').style.display = 'none'; document.getElementById('menu-fundo').style.display = 'none';
            }
        }

        function ajustarZoom(valor) { if(elementoSelecionado) elementoSelecionado.style.transform = `scale(${valor / 100})`; }
        function toggleVida() { if(elementoSelecionado) elementoSelecionado.classList.toggle('efeito-vida'); else alert("Selecione um item!"); }

        /* --- L√ìGICA DE EXPORTA√á√ÉO INTELIGENTE --- */
        function abrirModalExport() {
            const tipoFundo = document.getElementById('layer-fundo').getAttribute('data-tipo');
            const aviso = document.getElementById('aviso-tipo-fundo');
            
            if(tipoFundo === 'video') {
                aviso.innerHTML = "<i class='fas fa-exclamation-triangle'></i> Fundo de V√çDEO detectado.<br>Para salvar com movimento, use as op√ß√µes vermelhas (Gravar).";
                aviso.style.color = "#f59e0b";
            } else {
                aviso.innerText = "Fundo est√°tico. Voc√™ pode salvar como imagem ou v√≠deo.";
                aviso.style.color = "#999";
            }
            document.getElementById('modal-export').style.display = 'flex';
        }

        /* --- DOWNLOADER DE IMAGEM (BLOB FIX) --- */
        function baixarFoto() {
            const btn = document.getElementById('btn-dl-img');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="loader"></div> Processando...`;
            
            const tipoFundo = document.getElementById('layer-fundo').getAttribute('data-tipo');
            if(tipoFundo === 'video') {
                if(!confirm("‚ö†Ô∏è ATEN√á√ÉO: Fundo de v√≠deo detectado. A imagem ser√° est√°tica (pode ficar preta). Continuar?")) {
                    btn.innerHTML = originalText;
                    return;
                }
            }

            document.getElementById('modal-export').style.display = 'none';
            prepararCaptura();
            
            setTimeout(() => {
                html2canvas(document.getElementById('palco-criacao'), { 
                    backgroundColor: null, 
                    useCORS: true, 
                    scale: 2,
                    allowTaint: true
                }).then(canvas => {
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = `JDP_Arte_${Date.now()}.jpg`;
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        restaurarUI();
                        btn.innerHTML = originalText;
                    }, 'image/jpeg', 0.9);
                }).catch(err => {
                    alert("Erro ao gerar imagem: " + err);
                    restaurarUI();
                    btn.innerHTML = originalText;
                });
            }, 500);
        }

        /* --- MOTOR DE GRAVA√á√ÉO (HYPER-DRIVE VIDEO) --- */
        async function iniciarGravacao(segundos) {
            document.getElementById('modal-export').style.display = 'none';
            
            try {
                // 1. Solicita captura de tela (Obrigat√≥rio intera√ß√£o do usu√°rio)
                // Nota: Em mobile, isso pede permiss√£o do sistema.
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { 
                        mediaSource: "screen",
                        displaySurface: "browser", // Tenta focar na aba
                    }, 
                    audio: true 
                });
                
                modoGravacaoAtivo = true;
                prepararCaptura();
                
                // 2. SINCRONIZA√á√ÉO
                const bgVideo = document.getElementById('video-bg');
                if(bgVideo) { bgVideo.currentTime = 0; bgVideo.play(); }

                const audio = document.getElementById('audio-player'); 
                if(audio.src) { audio.currentTime = 0; audio.play(); }
                
                document.querySelectorAll('video').forEach(v => { if(v.id !== 'video-bg') v.play(); });

                // 3. Configura Codecs (Prioridade para compatibilidade Mobile)
                let options = { mimeType: 'video/webm;codecs=vp9' };
                if (MediaRecorder.isTypeSupported('video/mp4')) {
                    options = { mimeType: 'video/mp4' };
                } else if (MediaRecorder.isTypeSupported('video/webm;codecs=h264')) {
                    options = { mimeType: 'video/webm;codecs=h264' };
                }

                mediaRecorder = new MediaRecorder(stream, options);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                
                mediaRecorder.onstop = () => {
                    // GERA√á√ÉO DO ARQUIVO FINAL (BLOB SAFE)
                    const blob = new Blob(recordedChunks, { type: options.mimeType });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement("a");
                    a.style.display = "none";
                    a.href = url;
                    
                    // Define extens√£o baseada no tipo suportado
                    const ext = options.mimeType.includes('mp4') ? 'mp4' : 'webm';
                    a.download = `JDP_Video_${Date.now()}.${ext}`;
                    
                    document.body.appendChild(a);
                    a.click();
                    
                    // Limpeza
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 100);

                    stream.getTracks().forEach(track => track.stop());
                    restaurarUI();
                    
                    alert("‚úÖ DOWNLOAD INICIADO!\nVerifique sua galeria ou pasta de downloads.");
                };

                mediaRecorder.start();
                
                // Timer Visual
                const status = document.getElementById('status-gravacao');
                status.style.display = 'flex';
                let tempoRestante = segundos;
                
                const intervalo = setInterval(() => {
                    tempoRestante--;
                    document.getElementById('timer-rec').innerText = tempoRestante < 10 ? '0'+tempoRestante : tempoRestante;
                    
                    // Se o usu√°rio parar a grava√ß√£o manualmente pelo sistema
                    if(stream.getVideoTracks()[0].readyState === 'ended') {
                        clearInterval(intervalo);
                        if(mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                    }

                    if(tempoRestante <= 0) {
                        clearInterval(intervalo);
                        if(mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                    }
                }, 1000);

            } catch (err) {
                console.error(err);
                restaurarUI();
                // Mensagem amig√°vel para erro de permiss√£o
                if(err.name === 'NotAllowedError') {
                    alert("‚ö†Ô∏è Grava√ß√£o Cancelada.\nVoc√™ precisa permitir o compartilhamento de tela para gravar o v√≠deo.");
                } else {
                    alert("‚ö†Ô∏è Erro T√©cnico: " + err.message + "\nTente usar um navegador diferente (Chrome/Edge).");
                }
            }
        }

        function prepararCaptura() {
            document.querySelectorAll('.selecionado').forEach(e => e.classList.remove('selecionado'));
            document.querySelector('.dock-ferramentas').style.display = 'none';
            document.querySelector('.top-bar').style.display = 'none';
            document.getElementById('controle-zoom').style.display = 'none';
            document.getElementById('menu-fundo').style.display = 'none';
        }

        function restaurarUI() {
            modoGravacaoAtivo = false;
            document.querySelector('.dock-ferramentas').style.display = 'flex';
            document.querySelector('.top-bar').style.display = 'flex';
            document.getElementById('status-gravacao').style.display = 'none';
        }
    </script>
</body>
</html>
